' Gambas class file

'' Variablen festlegen
Static Public Version As String = Application.version
Public sSpeicherort As String
Public sSpeicherpfad As String = User.Home
Public sBackupquelle As String
Public sZieldatei As String
Static Public sKompri As Integer



'' Programmfunktionen hinzufügen
Public Sub Form_Open()
  ' Was soll passiert bei Start?
  sSpeicherort = "DATA-BACKUP"
  sZieldatei = "BACKUP_" & Year(Now) & "-" & Month(Now) & "-" & Day(Now) & ".tar"
  
  'Ladefunktion
  Dim hFile As Stream
  Dim sLine1 As String    ' Ladetextzeile
  Dim sLine2 As String    ' individueller Speicherpfad
  Dim sLine3 As String   ' Komprimierung an/aus
    
  'Konfigurationsdatei wird automatisch angelegt
   If Exist("~/.data-backup.txt") = False Then
    Shell "touch ~/.data-backup.txt" Wait
  Endif
  'hier wird geladen und in Variablen gefüllt
  hFile = Open "~/.data-backup.txt" For Read

   Line Input #hFile, sLine1
   Line Input #hFile, sLine2
   Line Input #hFile, sLine3
   Print sLine1
   Print sLine2
   Print sLine3
   sLine1 = Replace(sLine1, ",", " ")
   Print sLine1
   sBackupquelle = " " & sLine1     'hier ein Leerzeichen einfügen, sonst klemmt es
   If sLine2 <= " " Then sSpeicherpfad = sSpeicherpfad Else sSpeicherpfad = sLine2
   Print sSpeicherpfad
   If sLine3 = "1" Then sKompri = 1 Else sKompri = 0
   Print sKompri
   
End

Public Sub FirstInit()
  'Programm gleich nach Start ausblenden
   Me.Visible = False
End

Public Sub BackItUp()
  'Backup starten
  Dim bOk As Boolean

  Print sSpeicherpfad
  Print sZieldatei
  Print sSpeicherort
  Print sBackupquelle
  Print sSpeicherort &/ sZieldatei
  'Speicherort anlegen, falls nicht da
   If Exist(sSpeicherpfad &/ sSpeicherort) = False Then
    Message("Backup-Verzeichnis wird angelegt unter: " & sSpeicherpfad &/ sSpeicherort, "OK") 
    Shell "mkdir " & sSpeicherpfad &/ sSpeicherort Wait 
  Endif

  If sBackupquelle = "" Or If sBackupquelle = " " Then 
     Button1.Width = 308
     Button1.Background = &H99A025&
     Button1.Text = "Nichts ausgewählt" 
     Wait 0.6
     Button1.Width = 308
     Button1.Text = "Backup starten?"
     Button1.Background = &H00A025& 
     Wait 1
     Me.Visible = False
  Else If Exist(sSpeicherpfad &/ sSpeicherort &/ sZieldatei) Then 
     Button1.Width = 308
     Button1.Background = &00FF0000
     Button1.Text = "Füge zum Backup hinzu ..."
     TrayIcon1.Picture = Picture.Load("Icon2.png")
     'TrayIcon1.Picture.Refresh
     Wait 1 
     Shell "tar -uvf " & sSpeicherpfad &/ sSpeicherort &/ sZieldatei & sBackupquelle Wait 
     bOk = True
  Else If Not Exist(sSpeicherpfad &/ sSpeicherort &/ sZieldatei) Then 
     Button1.Width = 308
     Button1.Background = &00FF0000
     Button1.Text = "Lege Backup an ..."
     TrayIcon1.Picture = Picture.Load("Icon2.png")
     Wait 1
     Shell "tar -cvf " & sSpeicherpfad &/ sSpeicherort &/ sZieldatei & sBackupquelle Wait
     bOk = True
  Endif

  If bOk = True Then
    Button1.Width = 308
    Button1.Background = &H77A025&
    Button1.Text = "Backup fertig!" 
    Wait 1
    TrayIcon1.Picture = Picture.Load("Icon1.png")
    Button1.Width = 308
    Button1.Text = "Backup starten?"
    Button1.Background = &H00A025&
    Wait 1
    'Menu8.Text = "Programm wieder anzeigen"
    Me.Visible = False
  Endif 
End 

Public Sub Button1_Click()
  'Backup über den großen Knopf
  BackItUp()
End

Public Sub Menu2_Click()
  'Programm beenden
  TrayIcon1.Delete
  Me.Close()
End

Public Sub Menu3_Click()
  'Zeige die Einstellungen
  Einstellung.Show
End

Public Sub Menu4_Click()
  'Hilfe
  Hilfe.Show
End

Public Sub Menu5_Click()
  'Info
  Message.Info("Data-Backup \nVersion: " & Version, "Ok")
End

Public Sub Menu8_Click()
  ' Programmfenster anzeigen oder ausblenden
  If Me.Visible = False Then
    Me.Visible = True
  Else 
    Me.Visible = False
  Endif 
End

Public Sub Menu9_Click()
  'Backup über Menüeintrag
  BackItUp()
End

Public Sub TrayIcon1_Click()
  ' Trayicon einfacher Klick
   Me.Visible = True
   BackItUp
End

Public Sub Menu11_Click()
  ' URL öffnen
  Print Desktop.Type
  If Desktop.Type = "KDE" Then 
    Shell "firefox https://openyourlinux.blogspot.com/p/data-backup.html"
  Else 
    Desktop.Open("https://openyourlinux.blogspot.com/p/data-backup.html")
  Endif 
End

Public Sub Menu12_Click()
  'Anicht vom Speicherort
  Desktop.Open(sSpeicherpfad &/ sSpeicherort)
End

